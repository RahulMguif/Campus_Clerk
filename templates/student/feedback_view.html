{% extends 'student/index.html' %}
{% load static %}
{% block student_content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<div class="main-panel">        
    <div class="content-wrapper">
        <div class="row">
            <div class="col-12 grid-margin">
              <div class="card">
                <!-- ===========================Message Box In HTML============================= -->
                <!-- Django Messages Alert Box -->
                {% if messages %}
                <div id="alert-box">
                  {% for message in messages %}
                  <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                    <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
                <!-- ✅ Success Message Placeholder -->
                <div id="success-message" class="alert alert-success" style="display: none;"></div>
                <!-- ========================Message Box End===================================== -->


                <div class="card-body">
                    <h4 class="card-title">View FeedBack</h4>
                
                    <!-- ✅ Radio Button for Filtering Feedback -->
                    <div class="mb-3">
                        <input type="radio" name="feedback_filter" value="Academics" onclick="filterFeedback('Academics')" checked>
                        <label for="academics">Academics</label>
                
                        <input type="radio" name="feedback_filter" value="Infrastructure" onclick="filterFeedback('Infrastructure')">
                        <label for="infrastructure">Infrastructure</label>
                    </div>

                    <div class="d-flex mb-3">
                        <input type="date" id="start_date" class="form-control me-2" onchange="filterFeedback()">
                        <input type="date" id="end_date" class="form-control" onchange="filterFeedback()">
                    </div>
                

                    <!-- ✅ Feedback Data Table -->
                    <div class="table-responsive" id="feedback_table">
                        {% include 'student/partials/feedback_table.html' %}
                    </div>

                    <!-- ✅ Flagged Feedbacks Table -->
                    <h4 class="card-title mt-4">View Flagged Feedbacks</h4>
                    <div class="table-responsive" id="flagged_table">
                        {% include 'student/partials/flagged_feedback_table.html' %}
                    </div>
                </div>


                <!--============================View flaged feedbacks=-=-=-=-=-=-=----------=-=-=-=--->
                <!-- <div class="card-body">
                    <h4 class="card-title">View Flagged FeedBacks</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>SR No.</th>
                                    <th>Comment</th>
                                    <th>Submitted Date</th>
                                    <th>Flag Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in feeds_app %}
                                <tr>
                                    <td>{{forloop.counter}}</td>
                                    <td>{{t.comment}}</td>
                                    <td>{{t.submitted_date}}</td>
                                    <td>
                                        {% if t.is_flaged == 1 %}
                                            ❌
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No Flagged Feedbacks found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div> -->
                <!--============================View flaged feedbacks=-=-=-=-=-=-=----------=-=-=-=--->
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.lordicon.com/lordicon.js"></script>

<!-- ===============Script to hide message notification===================-->
 <!-- JavaScript to Auto-Hide the Alert After 3 Seconds -->
 <script>
    setTimeout(function() {
      var alertBox = document.getElementById("alert-box");
      if (alertBox) {
        alertBox.style.display = "none";
      }
    }, 3000); // Hides after 3 seconds
  </script>
  <!-- ===============Script to hide message notification ENDS===================-->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
      // ✅ Function to Filter Feedback Based on Selection
      function filterFeedback(feedbackFor = null) {
          var start_date = $('#start_date').val();
          var end_date = $('#end_date').val();
          
          // ✅ Get the selected feedback type (Academics/Infrastructure) if not provided
          if (!feedbackFor) {
              feedbackFor = $("input[name='feedback_filter']:checked").val();
          }
  
          $.ajax({
              url: '{% url "feedback_view" %}',
              type: 'GET',
              data: {
                  feedback_for: feedbackFor,
                  start_date: start_date,
                  end_date: end_date
              },
              success: function(response) {
                  $('#feedback_table').html(response.feedback_html);
                  $('#flagged_table').html(response.flagged_html);
              },
              error: function() {
                  alert("Error loading feedback data.");
              }
          });
      }
  
      // ✅ Event Listener for Feedback Type (Academics/Infrastructure)
      $(document).on('change', 'input[name="feedback_filter"]', function() {
          filterFeedback($(this).val());
      });
  
      // ✅ Event Listener for Date Range Filters
      $(document).on('change', '#start_date, #end_date', function(){
          filterFeedback();
      });
  
      // ✅ Handle Flagging via AJAX
      $(document).on('submit', '.flag-comment-form', function(e) {
          e.preventDefault();
          var form = $(this);
          var formData = form.serialize();
  
          $.ajax({
              url: '{% url "flag_comment" %}',
              type: 'POST',
              data: formData,
              success: function(response) {
                  $('#flagged_table').html(response.flagged_html);
                  $('#feedback_table').html(response.feedback_html);
                  $('.modal').modal('hide');
  
                  // ✅ Show success message
                  if (response.message) {
                      $("#success-message").text(response.message).fadeIn();
  
                      // ✅ Reload after 1 second to update data properly
                      setTimeout(function() {
                          location.reload();
                      }, 1000);
                  }
              },
              error: function() {
                  alert("Error flagging the comment. Please try again.");
              }
          });
      });
  
  </script>


{% endblock %}